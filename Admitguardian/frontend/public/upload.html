<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload & Risk Detection</title>
  <link rel="stylesheet" type="text/css" href="./css/equery.css">
  <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>
<body>

  <div class="page-container">

    <!-- Left: Document Upload/Editor Area -->
    <div class="upload-area">
      <h2>Upload Your Essay or Resume</h2>
      
      <div class="dropzone" id="dropzone">
        <p>Drag & Drop your file here</p>
        <p>or</p>
        <button class="upload-btn">Browse Files</button>
      </div>

      <textarea id="text-editor" class="text-editor" placeholder="Or paste your essay here..."></textarea>
      <a href="dashboard.html" class="dashboard-link"><button class="dashboard-btn">View Potential Risks</button></a>
    </div>

    <!-- Right: Live Risk Detection Sidebar -->
    <div class="risk-sidebar">
      <h3>Instant Risk Alerts</h3>
      <ul id="alerts-list">
        <li class="risk critical">⚠️ Weak Introduction Detected</li>
        <li class="risk warning">⚠️ Missing Research Experience</li>
        <li class="risk info">ℹ️ Tone could be more formal</li>
      </ul>
    </div>

  </div>
  <div class="app-overlay"></div>

  <script type="module">

import './js/equery.js';
import { FileLoader, openModal, openModal2, extractTextFromDataUrl } from './js/utils.js';

// upload.js
const filePicker = EQuery.elemt('input', null, null, {type: 'file', accept: 'application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain'}, 'display: none')
const fileLoader = window.fileLoader = new FileLoader();
const overlay = document.querySelector('.app-overlay')
const editor = document.getElementById('text-editor');
const alertsList = document.getElementById('alerts-list');

let timeout = null;

EQuery('.dropzone').append(filePicker);

fileLoader.onLoaded(async function (result, filename, ext) {
  let spinner = EQuery.elemt('div', null, 'app-spinner').spinner();
  let modal = new openModal({ content: [{ 'm2': {html: spinner}, 'm8': { text: {elt: document.createTextNode('Loading file contents...')} } }] });
  let blob = window.blob = fileLoader.toBlob(result);
  EQuery('.dropzone p:first-child').text(`${filename}.${ext}`);

  extractTextFromDataUrl(result, function (fileContent) {
    EQuery('#text-editor').val(fileContent);
    modal.close();
    checkAlerts();
  });

  /*switch(blob.type) {

    case 'text/plain':
      let fileContent = await blob.text();
      modal.close();
      EQuery('#text-editor').val(fileContent);
      checkAlerts();
      break;

    case 'application/pdf':
      let pdfContent = await extractTextFromPdfDataUrl(result);
      modal.close();
      EQuery('#text-editor').val(pdfContent);
      checkAlerts();
      break;

    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
      modal.close();
      break;

    default:
      new openModal2({ header: 'Invalid file format', content: [{ 'm12': { text: {elt: document.createTextNode('Only accepts the following file formats: *.txt, *.text, *.pdf, *.dot, *.doc, *.docx')} } }] });
      blob = null;
      break;
    
  }*/
 
});

// Helper function to create a risk alert element
function createRiskAlert(type, message) {
  const li = document.createElement('li');
  li.className = `risk ${type}`;
  li.textContent = message;
  return li;
}

// Basic risk detection rules
function detectRisks(text) {
  const risks = [];

  // Example checks:
  if (text.length < 100) {
    risks.push({ type: 'critical', message: 'Essay is too short!' });
  }
  if (!text.toLowerCase().includes('research')) {
    risks.push({ type: 'warning', message: 'No mention of research experience.' });
  }
  if ((text.match(/i am|my passion|i have always loved/gi) || []).length > 2) {
    risks.push({ type: 'info', message: 'Too many cliché phrases detected.' });
  }
  if (text.split(' ').length < 150) {
    risks.push({ type: 'warning', message: 'Essay is missing detailed examples.' });
  }
  if (text.includes('!!!') || text.includes('???')) {
    risks.push({ type: 'critical', message: 'Too many informal punctuations.' });
  }

  return risks;
}

function checkAlerts() {
  const text = editor.value;
  const risks = detectRisks(text);

  // Clear current alerts
  alertsList.innerHTML = '';

  if (risks.length === 0) {
    const safe = createRiskAlert('info', 'No major risks detected. Looking good!');
    alertsList.appendChild(safe);
  } else {
    risks.forEach(risk => {
      const alert = createRiskAlert(risk.type, `⚡ ${risk.message}`);
      alertsList.appendChild(alert);
    });
  }
}

// Listen to typing events
EQuery(editor).on('input', () => {
  clearTimeout(timeout);

  timeout = setTimeout(() => checkAlerts(), 1000); // wait 1 second after typing stops
});

EQuery(document).on('dragover', function(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
}, false);

EQuery(document).on('dragenter', function(event) {
    event.preventDefault();
    EQuery(overlay).show();
}, false);

EQuery(document).on('dragend', function(event) {
    event.preventDefault();
    EQuery(overlay).hide();
}, false);

EQuery(document).on('drop', function(event) {
    event.preventDefault();
    if (event.dataTransfer.types[0] === 'text/plain')
        return;
    if (event.dataTransfer.items) {
        fileLoader.loadItemList(event.dataTransfer.items);
    } else {
        fileLoader.loadFiles(event.dataTransfer.files);
    }
}, false);

EQuery('.upload-btn').on('click', () => filePicker[0].click());

filePicker.on('change', function () {
  let file = this.files[0];
  fileLoader.loadFile(file);
});

  </script>
</body>

</html>